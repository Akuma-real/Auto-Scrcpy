name: è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/**'

env:
  CARGO_TERM_COLOR: always

jobs:
  # æ£€æŸ¥æ˜¯å¦éœ€è¦å‘å¸ƒæ–°ç‰ˆæœ¬
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should-release: ${{ steps.version-check.outputs.should-release }}
      new-version: ${{ steps.version-check.outputs.new-version }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: æ£€æŸ¥ç‰ˆæœ¬å˜åŒ–
      id: version-check
      run: |
        # è·å–å½“å‰ç‰ˆæœ¬
        CURRENT_VERSION=$(grep '^version = ' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
        echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
        
        # æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç›¸åŒç‰ˆæœ¬çš„tag
        if git tag -l | grep -q "^v$CURRENT_VERSION$"; then
          echo "ç‰ˆæœ¬ v$CURRENT_VERSION å·²å­˜åœ¨ï¼Œè·³è¿‡å‘å¸ƒ"
          echo "should-release=false" >> $GITHUB_OUTPUT
        else
          echo "æ–°ç‰ˆæœ¬ v$CURRENT_VERSION éœ€è¦å‘å¸ƒ"
          echo "should-release=true" >> $GITHUB_OUTPUT
          echo "new-version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        fi

  # æ„å»ºé¡¹ç›®
  build:
    needs: check-version
    if: needs.check-version.outputs.should-release == 'true'
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact-name: scrcpy-launcher-windows-x64
            file-ext: .exe
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact-name: scrcpy-launcher-linux-x64
            file-ext: ""
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact-name: scrcpy-launcher-macos-x64
            file-ext: ""

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4

    - name: å®‰è£… Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: ç¼“å­˜ Cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: æ„å»ºé¡¹ç›®
      run: cargo build --release --target ${{ matrix.target }}

    - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
      shell: bash
      run: |
        mkdir -p release
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          cp target/${{ matrix.target }}/release/scrcpy-launcher.exe release/${{ matrix.artifact-name }}.exe
        else
          cp target/${{ matrix.target }}/release/scrcpy-launcher release/${{ matrix.artifact-name }}
        fi

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact-name }}
        path: release/${{ matrix.artifact-name }}${{ matrix.file-ext }}

  # åˆ›å»ºå‘å¸ƒ
  release:
    needs: [check-version, build]
    if: needs.check-version.outputs.should-release == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
      run: |
        mkdir -p release
        find artifacts -type f -exec cp {} release/ \;
        ls -la release/

    - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
      id: changelog
      run: |
        VERSION="${{ needs.check-version.outputs.new-version }}"
        echo "## ğŸš€ scrcpy æ™ºèƒ½å¯åŠ¨å™¨ v$VERSION" > CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### âœ¨ ä¸»è¦åŠŸèƒ½" >> CHANGELOG.md
        echo "- ğŸ”„ è‡ªåŠ¨æ£€æµ‹å¹¶ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„ scrcpy" >> CHANGELOG.md
        echo "- ğŸ“± å®æ—¶ç›‘æ§ Android è®¾å¤‡è¿æ¥çŠ¶æ€" >> CHANGELOG.md
        echo "- ğŸš€ è‡ªåŠ¨å¯åŠ¨ scrcpy è¿›è¡Œå±å¹•é•œåƒ" >> CHANGELOG.md
        echo "- ğŸ’» è·¨å¹³å°æ”¯æŒ (Windows/Linux/macOS)" >> CHANGELOG.md
        echo "- ğŸ›¡ï¸ æ— éœ€ç®¡ç†å‘˜æƒé™è¿è¡Œ" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### ğŸ“¦ ä¸‹è½½è¯´æ˜" >> CHANGELOG.md
        echo "- **Windows**: ä¸‹è½½ \`scrcpy-launcher-windows-x64.exe\`" >> CHANGELOG.md
        echo "- **Linux**: ä¸‹è½½ \`scrcpy-launcher-linux-x64\`" >> CHANGELOG.md
        echo "- **macOS**: ä¸‹è½½ \`scrcpy-launcher-macos-x64\`" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### ğŸ”§ ä½¿ç”¨æ–¹æ³•" >> CHANGELOG.md
        echo "1. ä¸‹è½½å¯¹åº”å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶" >> CHANGELOG.md
        echo "2. ç¡®ä¿ Android è®¾å¤‡å·²å¼€å¯ USB è°ƒè¯•" >> CHANGELOG.md
        echo "3. è¿æ¥è®¾å¤‡åˆ°ç”µè„‘" >> CHANGELOG.md
        echo "4. è¿è¡Œå¯åŠ¨å™¨ï¼Œç¨‹åºä¼šè‡ªåŠ¨å¤„ç†å…¶ä½™æ­¥éª¤" >> CHANGELOG.md
        
        # è®¾ç½®è¾“å‡ºå˜é‡
        {
          echo 'CHANGELOG<<EOF'
          cat CHANGELOG.md
          echo 'EOF'
        } >> $GITHUB_OUTPUT

    - name: åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ needs.check-version.outputs.new-version }}
        name: scrcpy æ™ºèƒ½å¯åŠ¨å™¨ v${{ needs.check-version.outputs.new-version }}
        body: ${{ steps.changelog.outputs.CHANGELOG }}
        files: release/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

