name: è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/**'

env:
  CARGO_TERM_COLOR: always

jobs:
  # æ£€æŸ¥æ˜¯å¦éœ€è¦å‘å¸ƒæ–°ç‰ˆæœ¬
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should-release: ${{ steps.version-check.outputs.should-release }}
      new-version: ${{ steps.version-check.outputs.new-version }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: æ£€æŸ¥ç‰ˆæœ¬å˜åŒ–
      id: version-check
      run: |
        # è·å–å½“å‰ç‰ˆæœ¬
        CURRENT_VERSION=$(grep '^version = ' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
        echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
        
        # æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç›¸åŒç‰ˆæœ¬çš„tag
        if git tag -l | grep -q "^v$CURRENT_VERSION$"; then
          echo "ç‰ˆæœ¬ v$CURRENT_VERSION å·²å­˜åœ¨ï¼Œè·³è¿‡å‘å¸ƒ"
          echo "should-release=false" >> $GITHUB_OUTPUT
        else
          echo "æ–°ç‰ˆæœ¬ v$CURRENT_VERSION éœ€è¦å‘å¸ƒ"
          echo "should-release=true" >> $GITHUB_OUTPUT
          echo "new-version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        fi

  # æ„å»ºWindowsç‰ˆæœ¬
  build:
    needs: check-version
    if: needs.check-version.outputs.should-release == 'true'
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: å®‰è£… Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-pc-windows-msvc

    - name: ç¼“å­˜ Cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: æ„å»ºé¡¹ç›®
      run: cargo build --release --target x86_64-pc-windows-msvc

    - name: ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„ scrcpy
      run: |
        # è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯
        $latestRelease = Invoke-RestMethod -Uri "https://api.github.com/repos/Genymobile/scrcpy/releases/latest"
        $version = $latestRelease.tag_name
        
        Write-Host "è·å–åˆ° scrcpy ç‰ˆæœ¬: $version"
        Write-Host "å¯ç”¨çš„èµ„æºæ–‡ä»¶:"
        $latestRelease.assets | ForEach-Object { Write-Host "  - $($_.name)" }
        
        # æŸ¥æ‰¾ Windows ç‰ˆæœ¬çš„ä¸‹è½½é“¾æ¥ï¼ˆå¯èƒ½çš„æ–‡ä»¶åæ ¼å¼ï¼‰
        $windowsAsset = $latestRelease.assets | Where-Object { 
          $_.name -like "*win64*" -or 
          $_.name -like "*windows*" -or 
          $_.name -like "*win*" 
        } | Select-Object -First 1
        
        if (-not $windowsAsset) {
          Write-Error "æœªæ‰¾åˆ° Windows ç‰ˆæœ¬çš„ scrcpy"
          Write-Host "å°è¯•æŸ¥æ‰¾æ‰€æœ‰ .zip æ–‡ä»¶:"
          $latestRelease.assets | Where-Object { $_.name -like "*.zip" } | ForEach-Object { Write-Host "  - $($_.name)" }
          
          # å¦‚æœæ²¡æ‰¾åˆ°ç‰¹å®šçš„ Windows ç‰ˆæœ¬ï¼Œå°è¯•ä½¿ç”¨ç¬¬ä¸€ä¸ª zip æ–‡ä»¶
          $windowsAsset = $latestRelease.assets | Where-Object { $_.name -like "*.zip" } | Select-Object -First 1
        }
        
        if (-not $windowsAsset) {
          Write-Error "æœªæ‰¾åˆ°ä»»ä½•å¯ç”¨çš„ scrcpy ä¸‹è½½æ–‡ä»¶"
          exit 1
        }
        
        $downloadUrl = $windowsAsset.browser_download_url
        $fileName = $windowsAsset.name
        
        Write-Host "ä¸‹è½½ scrcpy $version"
        Write-Host "æ–‡ä»¶å: $fileName"
        Write-Host "ä¸‹è½½åœ°å€: $downloadUrl"
        
        # ä¸‹è½½ scrcpy
        Invoke-WebRequest -Uri $downloadUrl -OutFile "scrcpy.zip"
        
        # è§£å‹åˆ°ä¸´æ—¶æ–‡ä»¶å¤¹
        Expand-Archive -Path "scrcpy.zip" -DestinationPath "temp_extract" -Force
        
        # æŸ¥æ‰¾è§£å‹åçš„æ–‡ä»¶å¤¹
        $extractedFolders = Get-ChildItem -Path "temp_extract" -Directory
        Write-Host "è§£å‹åçš„æ–‡ä»¶å¤¹:"
        $extractedFolders | ForEach-Object { Write-Host "  - $($_.Name)" }
        
        # æ‰¾åˆ°åŒ…å« scrcpy.exe çš„æ–‡ä»¶å¤¹
        $scrcpyFolder = $null
        foreach ($folder in $extractedFolders) {
          $scrcpyExe = Join-Path $folder.FullName "scrcpy.exe"
          if (Test-Path $scrcpyExe) {
            $scrcpyFolder = $folder
            break
          }
        }
        
        if (-not $scrcpyFolder) {
          # å¦‚æœæ²¡æœ‰å­æ–‡ä»¶å¤¹ï¼Œæ£€æŸ¥æ˜¯å¦ç›´æ¥è§£å‹åˆ°äº† temp_extract
          $scrcpyExe = Join-Path "temp_extract" "scrcpy.exe"
          if (Test-Path $scrcpyExe) {
            # ç›´æ¥ä½¿ç”¨ temp_extract ä½œä¸º scrcpy æ–‡ä»¶å¤¹
            Rename-Item "temp_extract" "scrcpy"
            Write-Host "scrcpy æ–‡ä»¶ç›´æ¥è§£å‹ï¼Œé‡å‘½åå®Œæˆ"
          } else {
            Write-Error "æœªæ‰¾åˆ° scrcpy.exe æ–‡ä»¶"
            Write-Host "temp_extract ç›®å½•å†…å®¹:"
            Get-ChildItem -Path "temp_extract" -Recurse | ForEach-Object { Write-Host "  - $($_.FullName)" }
            exit 1
          }
        } else {
          # ç§»åŠ¨æ‰¾åˆ°çš„æ–‡ä»¶å¤¹åˆ°æ ¹ç›®å½•å¹¶é‡å‘½å
          Move-Item $scrcpyFolder.FullName "scrcpy"
          Remove-Item "temp_extract" -Recurse -Force
          Write-Host "scrcpy æ–‡ä»¶å¤¹é‡å‘½åå®Œæˆ: $($scrcpyFolder.Name) -> scrcpy"
        }
        
        # éªŒè¯ scrcpy æ–‡ä»¶å¤¹å†…å®¹
        Write-Host "scrcpy æ–‡ä»¶å¤¹å†…å®¹:"
        Get-ChildItem -Path "scrcpy" | ForEach-Object { Write-Host "  - $($_.Name)" }

    - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
      run: |
        mkdir release
        
        # å¤åˆ¶å¯åŠ¨å™¨ç¨‹åº
        copy target\x86_64-pc-windows-msvc\release\scrcpy-launcher.exe release\scrcpy-launcher.exe
        
        # å¤åˆ¶æ•´ä¸ª scrcpy æ–‡ä»¶å¤¹
        xcopy scrcpy release\scrcpy\ /E /I /H /Y
        
        # åˆ›å»ºä½¿ç”¨è¯´æ˜
        echo "# scrcpy æ™ºèƒ½å¯åŠ¨å™¨" > release\README.md
        echo "" >> release\README.md
        echo "## ä½¿ç”¨æ–¹æ³•" >> release\README.md
        echo "1. ç¡®ä¿ Android è®¾å¤‡å·²å¼€å¯ USB è°ƒè¯•" >> release\README.md
        echo "2. è¿æ¥è®¾å¤‡åˆ°ç”µè„‘" >> release\README.md
        echo "3. åŒå‡»è¿è¡Œ scrcpy-launcher.exe" >> release\README.md
        echo "4. ç¨‹åºä¼šè‡ªåŠ¨æ£€æµ‹è®¾å¤‡å¹¶å¯åŠ¨ scrcpy" >> release\README.md
        echo "" >> release\README.md
        echo "## åŒ…å«ç»„ä»¶" >> release\README.md
        echo "- scrcpy-launcher.exe: æ™ºèƒ½å¯åŠ¨å™¨ä¸»ç¨‹åº" >> release\README.md
        echo "- scrcpy/: scrcpy å®Œæ•´ç¨‹åºåŒ…" >> release\README.md
        
        # æ˜¾ç¤ºæ–‡ä»¶ç»“æ„
        Write-Host "å‘å¸ƒæ–‡ä»¶ç»“æ„:"
        tree release /F

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: scrcpy-launcher-windows
        path: release/

  # åˆ›å»ºå‘å¸ƒ
  release:
    needs: [check-version, build]
    if: needs.check-version.outputs.should-release == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
      run: |
        mkdir -p release-temp
        
        # å¤åˆ¶æ„å»ºäº§ç‰©åˆ°ä¸´æ—¶ç›®å½•
        cp -r artifacts/scrcpy-launcher-windows/* release-temp/
        
        # åˆ›å»ºæœ€ç»ˆçš„å‹ç¼©åŒ…
        cd release-temp
        zip -r ../scrcpy-launcher-windows-v${{ needs.check-version.outputs.new-version }}.zip .
        cd ..
        
        # ç§»åŠ¨å‹ç¼©åŒ…åˆ° release ç›®å½•
        mkdir -p release
        mv scrcpy-launcher-windows-v${{ needs.check-version.outputs.new-version }}.zip release/
        
        ls -la release/

    - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
      id: changelog
      run: |
        VERSION="${{ needs.check-version.outputs.new-version }}"
        echo "## ğŸš€ scrcpy æ™ºèƒ½å¯åŠ¨å™¨ v$VERSION" > CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### âœ¨ ä¸»è¦åŠŸèƒ½" >> CHANGELOG.md
        echo "- ğŸ“± å®æ—¶ç›‘æ§ Android è®¾å¤‡è¿æ¥çŠ¶æ€" >> CHANGELOG.md
        echo "- ğŸš€ è‡ªåŠ¨å¯åŠ¨ scrcpy è¿›è¡Œå±å¹•é•œåƒ" >> CHANGELOG.md
        echo "- ğŸ’» ç°ä»£åŒ– TUI ç•Œé¢ï¼Œç¾è§‚å®ç”¨" >> CHANGELOG.md
        echo "- âš¡ å¿«é€Ÿå“åº”ï¼Œ1ç§’å†…æ£€æµ‹è®¾å¤‡å˜åŒ–" >> CHANGELOG.md
        echo "- ğŸ“¦ å®Œæ•´æ‰“åŒ…ï¼ŒåŒ…å«æœ€æ–°ç‰ˆæœ¬ scrcpy" >> CHANGELOG.md
        echo "- ğŸ›¡ï¸ æ— éœ€ç®¡ç†å‘˜æƒé™è¿è¡Œ" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### ğŸ“¦ ä¸‹è½½è¯´æ˜" >> CHANGELOG.md
        echo "- ä¸‹è½½å®Œæ•´çš„å‘å¸ƒåŒ…ï¼Œè§£å‹åå³å¯ä½¿ç”¨" >> CHANGELOG.md
        echo "- åŒ…å« scrcpy-launcher.exe å’Œå®Œæ•´çš„ scrcpy ç¨‹åº" >> CHANGELOG.md
        echo "- æ”¯æŒ Windows 10/11 ç³»ç»Ÿ" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### ğŸ”§ ä½¿ç”¨æ–¹æ³•" >> CHANGELOG.md
        echo "1. ä¸‹è½½å¹¶è§£å‹å‘å¸ƒåŒ…" >> CHANGELOG.md
        echo "2. ç¡®ä¿ Android è®¾å¤‡å·²å¼€å¯ USB è°ƒè¯•" >> CHANGELOG.md
        echo "3. è¿æ¥è®¾å¤‡åˆ°ç”µè„‘" >> CHANGELOG.md
        echo "4. åŒå‡»è¿è¡Œ scrcpy-launcher.exe" >> CHANGELOG.md
        echo "5. ç¨‹åºä¼šè‡ªåŠ¨æ£€æµ‹è®¾å¤‡å¹¶å¯åŠ¨ scrcpy" >> CHANGELOG.md
        
        # è®¾ç½®è¾“å‡ºå˜é‡
        {
          echo 'CHANGELOG<<EOF'
          cat CHANGELOG.md
          echo 'EOF'
        } >> $GITHUB_OUTPUT

    - name: åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ needs.check-version.outputs.new-version }}
        name: scrcpy æ™ºèƒ½å¯åŠ¨å™¨ v${{ needs.check-version.outputs.new-version }}
        body: ${{ steps.changelog.outputs.CHANGELOG }}
        files: release/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

