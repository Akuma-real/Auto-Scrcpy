name: è‡ªåŠ¨è·å–æœ€æ–°ç‰ˆæœ¬

on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´0ç‚¹è¿è¡Œ (åŒ—äº¬æ—¶é—´8ç‚¹)
    - cron: '0 0 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # å…è®¸æ¨é€åˆ°ä»“åº“

jobs:
  get-latest-version:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: è·å–æœ¬ç¨‹åºå’Œscrcpyæœ€æ–°ç‰ˆæœ¬
      id: get_versions
      run: |
        # è·å–æœ¬ç¨‹åºï¼ˆscrcpy-launcherï¼‰æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯
        echo "ğŸ” æ£€æŸ¥æœ¬ç¨‹åºæœ€æ–°ç‰ˆæœ¬..."
        LAUNCHER_RELEASE=$(curl -s https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/latest)
        
        if [ "$LAUNCHER_RELEASE" != "null" ] && [ -n "$LAUNCHER_RELEASE" ]; then
          LAUNCHER_VERSION=$(echo "$LAUNCHER_RELEASE" | jq -r '.tag_name')
          echo "æœ¬ç¨‹åºæœ€æ–°ç‰ˆæœ¬: $LAUNCHER_VERSION"
        else
          LAUNCHER_VERSION="v0.1.5"  # é»˜è®¤ç‰ˆæœ¬
          echo "æœªæ‰¾åˆ°æœ¬ç¨‹åºå‘å¸ƒç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬: $LAUNCHER_VERSION"
        fi
        
        # è·å–scrcpyæœ€æ–°ç‰ˆæœ¬ä¿¡æ¯
        echo "ğŸ” æ£€æŸ¥scrcpyæœ€æ–°ç‰ˆæœ¬..."
        SCRCPY_RELEASE=$(curl -s https://api.github.com/repos/Genymobile/scrcpy/releases/latest)
        
        if [ -z "$SCRCPY_RELEASE" ] || [ "$SCRCPY_RELEASE" = "null" ]; then
          echo "âŒ æ— æ³•è·å–scrcpyæœ€æ–°ç‰ˆæœ¬ä¿¡æ¯"
          exit 1
        fi
        
        SCRCPY_VERSION=$(echo "$SCRCPY_RELEASE" | jq -r '.tag_name')
        SCRCPY_DOWNLOAD_URL=$(echo "$SCRCPY_RELEASE" | jq -r '.assets[] | select(.name | contains("win64")) | .browser_download_url')
        
        if [ -z "$SCRCPY_VERSION" ] || [ "$SCRCPY_VERSION" = "null" ]; then
          echo "âŒ æ— æ³•è§£æscrcpyç‰ˆæœ¬å·"
          exit 1
        fi
        
        if [ -z "$SCRCPY_DOWNLOAD_URL" ] || [ "$SCRCPY_DOWNLOAD_URL" = "null" ]; then
          echo "âŒ æ— æ³•æ‰¾åˆ°scrcpy Windows 64ä½ä¸‹è½½é“¾æ¥"
          exit 1
        fi
        
        echo "scrcpyæœ€æ–°ç‰ˆæœ¬: $SCRCPY_VERSION"
        echo "scrcpyä¸‹è½½é“¾æ¥: $SCRCPY_DOWNLOAD_URL"
        
        # è¯»å–å½“å‰ç‰ˆæœ¬ä¿¡æ¯ï¼ˆå¦‚æœæ–‡ä»¶å­˜åœ¨ï¼‰
        CURRENT_LAUNCHER_VERSION=""
        CURRENT_SCRCPY_VERSION=""
        if [ -f "latest_version" ]; then
          CURRENT_LAUNCHER_VERSION=$(jq -r '.launcher_version // ""' latest_version 2>/dev/null || echo "")
          CURRENT_SCRCPY_VERSION=$(jq -r '.scrcpy_version // .version // ""' latest_version 2>/dev/null || echo "")
        fi
        
        echo "å½“å‰æœ¬ç¨‹åºç‰ˆæœ¬: $CURRENT_LAUNCHER_VERSION"
        echo "å½“å‰scrcpyç‰ˆæœ¬: $CURRENT_SCRCPY_VERSION"
        
        # è¾“å‡ºåˆ°GitHub Actions
        echo "launcher_version=$LAUNCHER_VERSION" >> $GITHUB_OUTPUT
        echo "scrcpy_version=$SCRCPY_VERSION" >> $GITHUB_OUTPUT
        echo "scrcpy_download_url=$SCRCPY_DOWNLOAD_URL" >> $GITHUB_OUTPUT
        echo "current_launcher_version=$CURRENT_LAUNCHER_VERSION" >> $GITHUB_OUTPUT
        echo "current_scrcpy_version=$CURRENT_SCRCPY_VERSION" >> $GITHUB_OUTPUT
    
    - name: æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦å˜åŒ–
      id: check_changes
      run: |
        LAUNCHER_VERSION="${{ steps.get_versions.outputs.launcher_version }}"
        SCRCPY_VERSION="${{ steps.get_versions.outputs.scrcpy_version }}"
        SCRCPY_DOWNLOAD_URL="${{ steps.get_versions.outputs.scrcpy_download_url }}"
        
        CURRENT_LAUNCHER_VERSION="${{ steps.get_versions.outputs.current_launcher_version }}"
        CURRENT_SCRCPY_VERSION="${{ steps.get_versions.outputs.current_scrcpy_version }}"
        
        LAUNCHER_CHANGED=false
        SCRCPY_CHANGED=false
        
        # æ£€æŸ¥æœ¬ç¨‹åºç‰ˆæœ¬æ˜¯å¦å˜åŒ–
        if [ "$LAUNCHER_VERSION" != "$CURRENT_LAUNCHER_VERSION" ]; then
          echo "ğŸ”„ æ£€æµ‹åˆ°æœ¬ç¨‹åºæ–°ç‰ˆæœ¬: $CURRENT_LAUNCHER_VERSION -> $LAUNCHER_VERSION"
          LAUNCHER_CHANGED=true
        else
          echo "ğŸ“‹ æœ¬ç¨‹åºç‰ˆæœ¬æ— å˜åŒ–: $LAUNCHER_VERSION"
        fi
        
        # æ£€æŸ¥scrcpyç‰ˆæœ¬æ˜¯å¦å˜åŒ–
        if [ "$SCRCPY_VERSION" != "$CURRENT_SCRCPY_VERSION" ]; then
          echo "ğŸ”„ æ£€æµ‹åˆ°scrcpyæ–°ç‰ˆæœ¬: $CURRENT_SCRCPY_VERSION -> $SCRCPY_VERSION"
          SCRCPY_CHANGED=true
        else
          echo "ğŸ“‹ scrcpyç‰ˆæœ¬æ— å˜åŒ–: $SCRCPY_VERSION"
        fi
        
        # å¦‚æœä»»ä¸€ç‰ˆæœ¬å‘ç”Ÿå˜åŒ–ï¼Œæ›´æ–°æ–‡ä»¶
        if [ "$LAUNCHER_CHANGED" = true ] || [ "$SCRCPY_CHANGED" = true ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          
          # åˆ›å»ºæ–°çš„ç‰ˆæœ¬æ–‡ä»¶ï¼ŒåŒ…å«ä¸¤ä¸ªç‰ˆæœ¬ä¿¡æ¯
          cat > latest_version << EOF
        {
          "launcher_version": "$LAUNCHER_VERSION",
          "scrcpy_version": "$SCRCPY_VERSION",
          "scrcpy_download_url": "$SCRCPY_DOWNLOAD_URL",
          "updated_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "changelog": {
            "launcher_changed": $LAUNCHER_CHANGED,
            "scrcpy_changed": $SCRCPY_CHANGED
          }
        }
        EOF
        else
          echo "ğŸ“‹ æ‰€æœ‰ç‰ˆæœ¬å‡æ— å˜åŒ–"
          echo "changed=false" >> $GITHUB_OUTPUT
        fi
        
        echo "launcher_changed=$LAUNCHER_CHANGED" >> $GITHUB_OUTPUT
        echo "scrcpy_changed=$SCRCPY_CHANGED" >> $GITHUB_OUTPUT
    
    - name: æäº¤ç‰ˆæœ¬æ–‡ä»¶
      if: steps.check_changes.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add latest_version
        
        # åˆ›å»ºæäº¤æ¶ˆæ¯
        COMMIT_MSG="ğŸ”„ ç‰ˆæœ¬æ›´æ–°"
        if [ "${{ steps.check_changes.outputs.launcher_changed }}" = "true" ]; then
          COMMIT_MSG="$COMMIT_MSG - æœ¬ç¨‹åº: ${{ steps.get_versions.outputs.launcher_version }}"
        fi
        if [ "${{ steps.check_changes.outputs.scrcpy_changed }}" = "true" ]; then
          COMMIT_MSG="$COMMIT_MSG - scrcpy: ${{ steps.get_versions.outputs.scrcpy_version }}"
        fi
        
        git commit -m "$COMMIT_MSG"
        git push
    
    - name: åˆ›å»ºå‘å¸ƒè¯´æ˜
      if: steps.check_changes.outputs.changed == 'true'
      run: |
        echo "âœ… ç‰ˆæœ¬ä¿¡æ¯å·²æ›´æ–°"
        if [ "${{ steps.check_changes.outputs.launcher_changed }}" = "true" ]; then
          echo "ğŸ“¦ æœ¬ç¨‹åºæœ€æ–°ç‰ˆæœ¬: ${{ steps.get_versions.outputs.launcher_version }}"
        fi
        if [ "${{ steps.check_changes.outputs.scrcpy_changed }}" = "true" ]; then
          echo "ğŸ“¦ scrcpyæœ€æ–°ç‰ˆæœ¬: ${{ steps.get_versions.outputs.scrcpy_version }}"
        fi
        echo "ğŸ• æ›´æ–°æ—¶é—´: $(date)"